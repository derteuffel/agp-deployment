import{r as j,d as Y,b as v,m as Z,o as $,a as z,aK as ee,aL as se,aM as te,j as e,x as m,y as re,z as F,D as i,F as u,n as p,a7 as L}from"./index-CbhSdBPv.js";import{a as ae,b as ne}from"./index-CLio4mqX.js";import{a as P}from"./SpeciesTypes-1YqtMNOJ.js";import{u as g,w as oe}from"./xlsx-BiIUQI8q.js";import{P as O}from"./Pagination-mCE3J0VE.js";import"./Anchor-iNQrUsNx.js";function ue(){const[N,S]=j.useState(!1),[U,k]=j.useState(!1),[E,D]=j.useState(1),C=12,f=Y(),{speciesList:A,status:b,error:R,createStatus:_}=v(s=>s.species);v(s=>s.units),v(s=>s.assetType);const[x,w]=j.useState([]),[y,V]=j.useState(null),{user:a}=Z(),d=$({resolver:L(P)}),l=$({resolver:L(P)});z.useEffect(()=>{f(ee()),f(se()),f(te())},[f]);const H=()=>{const s=x.map((B,X)=>({"#":X+1,"Numéro de référence":B.referenceNumber,Nom:B.name})),t=g.json_to_sheet(s),r=g.book_new();g.book_append_sheet(r,t,"Vulnérabilités");const n=oe(r,{bookType:"xlsx",type:"array"}),c=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=window.URL.createObjectURL(c),o=document.createElement("a");o.href=h,o.setAttribute("download","vulnerabilites.xlsx"),document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(h)},T=()=>{S(!1),d.reset()},J=()=>S(!0),M=()=>{k(!1),V(null),l.reset()},G=s=>{V(s),l.reset({name:s.name}),k(!0)},I=Math.ceil(x.length/C),K=s=>{D(s)},q=async(s,t)=>{try{const r=a==null?void 0:a.token;if(!(await fetch(`http://plaintes.celluleinfra.org:8181/api/v1/vulnerability-level/${s}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({reason:t})})).ok)throw new Error("Failed to delete vulnerability");w(c=>c.filter(h=>h.id!==s)),p.success("Vulnérabilité supprimée avec succès !",{autoClose:2e3})}catch{p.error("Erreur lors de la suppression de la vulnérabilité",{autoClose:4e3})}},Q=async s=>{try{const t=a==null?void 0:a.token,r=await fetch("http://plaintes.celluleinfra.org:8181/api/v1/vulnerability-level",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(s)});if(!r.ok)throw new Error("Failed to add vulnerability");const n=await r.json();w(c=>[...c,n]),p.success("Vulnérabilité ajoutée avec succès !",{autoClose:2e3}),T()}catch{p.error("Erreur lors de l'ajout de la vulnérabilité",{autoClose:4e3})}};z.useEffect(()=>{(async()=>{try{const t=a==null?void 0:a.token,r=await fetch("http://plaintes.celluleinfra.org:8181/api/v1/vulnerability-level",{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error("Failed to fetch vulnerabilities");const n=await r.json();w(n)}catch(t){console.error("Error fetching vulnerabilities:",t)}})()},[]);const W=async(s,t)=>{try{const r=a==null?void 0:a.token,n=await fetch(`http://plaintes.celluleinfra.org:8181/api/v1/vulnerability-level/${s}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(t)});if(!n.ok)throw new Error("Failed to update vulnerability");const c=await n.json();w(h=>h.map(o=>o.id===s?c:o)),p.success("Vulnérabilité mise à jour avec succès !",{autoClose:2e3}),M()}catch{p.error("Erreur lors de la mise à jour de la vulnérabilité",{autoClose:4e3})}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h3",{className:"fw-bold",children:"Liste des Vulnérabilités "}),e.jsx(m,{variant:"success",onClick:H,className:"shadow-sm ms-2",children:"Exporter en Excel"}),e.jsx(m,{variant:"primary",onClick:J,className:"shadow-sm",children:"Ajouter une Vulnerabilite"})]}),e.jsxs("div",{children:[e.jsxs(re,{striped:!0,bordered:!0,hover:!0,responsive:!0,className:"shadow-sm",children:[e.jsx("thead",{className:"table-dark",children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Actions"})]})}),e.jsxs("tbody",{children:[b==="loading"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:e.jsx(F,{animation:"border",size:"sm",className:"text-primary"})})}),b==="failed"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center text-danger",children:R})}),b==="succeeded"&&A.length>0&&(x==null?void 0:x.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:(E-1)*C+t+1}),e.jsx("td",{children:s.name}),e.jsx("td",{style:{width:"1%"},children:e.jsxs("div",{className:"d-flex gap-2 align-items-center justify-content-center",children:[e.jsx(m,{variant:"warning",size:"sm",className:"shadow-sm",onClick:()=>G(s),children:e.jsx(ae,{size:20})}),e.jsx(m,{variant:"danger",size:"sm",onClick:()=>q(s.id,"Données créées par erreur"),className:"shadow-sm",children:e.jsx(ne,{size:20})})]})})]},s.id))),b==="succeeded"&&A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:"Aucune espèce trouvée"})})]})]}),e.jsx("div",{className:"d-flex justify-content-end",children:e.jsx(O,{children:Array.from({length:I},(s,t)=>e.jsx(O.Item,{active:t+1===E,onClick:()=>K(t+1),children:t+1},t+1))})})]})]}),N&&e.jsxs(i,{show:N,onHide:T,centered:!0,children:[e.jsx(i.Header,{closeButton:!0,children:e.jsxs(i.Title,{children:["Créer une Vulnerabilite ",_==="loading"&&e.jsx(F,{size:"sm",className:"ms-2"})]})}),e.jsx(i.Body,{children:e.jsxs("form",{onSubmit:d.handleSubmit(Q),children:[e.jsxs(u.Group,{className:"mb-3",children:[e.jsx(u.Label,{className:"fw-bold",children:"Nom"}),e.jsx(u.Control,{id:"name",className:`form-control shadow-sm ${d.formState.errors.name?"is-invalid":""}`,...d.register("name")}),d.formState.errors.name&&e.jsx("div",{className:"invalid-feedback",children:d.formState.errors.name.message})]}),e.jsx(m,{variant:"primary",type:"submit",className:"w-100 shadow-sm",children:"Enregistrer"})]})})]}),y&&e.jsxs(i,{show:U,onHide:M,centered:!0,children:[e.jsx(i.Header,{closeButton:!0,children:e.jsx(i.Title,{children:"Modifier la Vulnerabilite"})}),e.jsx(i.Body,{children:y&&e.jsxs("form",{onSubmit:l.handleSubmit(s=>W(y.id,s)),children:[e.jsxs(u.Group,{className:"mb-3",children:[e.jsx(u.Label,{className:"fw-bold",children:"Nom"}),e.jsx(u.Control,{id:"name",className:`form-control shadow-sm ${l.formState.errors.name?"is-invalid":""}`,...l.register("name")}),l.formState.errors.name&&e.jsx("div",{className:"invalid-feedback",children:l.formState.errors.name.message})]}),e.jsx(m,{variant:"primary",type:"submit",className:"w-100 shadow-sm",children:"Mettre à jour"})]})})]})]})}export{ue as default};
