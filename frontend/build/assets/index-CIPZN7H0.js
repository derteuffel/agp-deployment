import{o as U,a as re,d as Q,b as L,j as e,x as f,J as je,D as l,z as B,F as t,a7 as J,cQ as xe,cR as pe,n as p,al as fe,cS as ge,cT as be,r as i,m as ve,at as Se,c8 as ye,c9 as Ce,cz as _,cG as ee,cN as Ne,cU as we,cV as ke,ca as se,y as Ee,cW as Ve,cX as Ae}from"./index-CbhSdBPv.js";import{B as Le}from"./Badge-PdELC0tt.js";import{L as te}from"./ListGroup-ZUxkTij-.js";import"./hook-Bfbc0OXD.js";import"./Nav-C3lV-Y8S.js";const Te=({id:r,name:E})=>{const{register:b,handleSubmit:n,setError:u,formState:{errors:a}}=U({defaultValues:{id:r},resolver:J(xe)}),[v,m]=re.useState(!1),j=Q(),{deleteStatus:h}=L(g=>g.villages),c=async g=>{try{await j(pe(g)).unwrap(),p.success("Quartier/Village supprimé avec succès",{autoClose:2e3}),x()}catch(w){u("reason",{message:String(w)})}},x=()=>{m(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(f,{type:"button",variant:"danger",onClick:()=>m(!0),children:e.jsx(je,{})}),v&&e.jsxs(l,{show:v,onHide:x,centered:!0,children:[e.jsx(l.Header,{closeButton:!0,children:e.jsxs(l.Title,{children:["Supprimer le quartier/village"," ",h==="loading"&&e.jsx(B,{animation:"border",size:"sm"})]})}),e.jsxs(t,{onSubmit:n(c),children:[e.jsxs(l.Body,{className:"p-4",children:[e.jsx("p",{children:"Confirmer la suppression du quartier/village ?"}),e.jsx("p",{className:"fw-bold",children:E}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Raison"}),e.jsxs(t.Select,{...b("reason",{required:"Ce champ est requis"}),children:[e.jsx("option",{value:"",children:"-- Choisir --"}),e.jsx("option",{value:"Bad data",children:"Données erronées"}),e.jsx("option",{value:"Data created by mistake and more",children:"Données créées par erreur"})]}),a.reason&&e.jsx("span",{className:"text-danger mt-2",children:a.reason.message})]})]}),e.jsx(l.Footer,{children:e.jsxs("div",{className:"d-flex align-items-center gap-3 justify-content-end",children:[e.jsx(f,{variant:"outline-secondary",onClick:x,type:"button",children:"Annuler"}),e.jsx(f,{variant:"danger",type:"submit",children:"Supprimer"})]})})]})]})]})},ze=({village:r,dispashing:E})=>{const[b,n]=re.useState(!1),u=Q(),{updateStatus:a}=L(g=>g.villages),{register:v,handleSubmit:m,reset:j,formState:{errors:h}}=U({resolver:J(ge),defaultValues:{id:r.id,name:r.name,sector:r.sector,territory:r.territory,committeeName:r.committeeName,referenceNumber:r.referenceNumber}}),c=()=>{j({id:r.id,name:r.name,sector:r.sector,territory:r.territory,committeeName:r.committeeName,referenceNumber:r.referenceNumber}),n(!1)},x=async g=>{const{id:w,...V}=g,N=p.loading("Mise à jour en cours...");try{await u(be({id:w,...V})).unwrap();const C=`${r.sector}`;console.log("communeId",C),console.log("village",r),p.update(N,{render:"Quartier/Village mis à jour avec succès",type:"success",isLoading:!1,autoClose:2e3}),E(),c()}catch(C){console.error("Échec de la mise à jour :",C),p.update(N,{render:C instanceof Error?C.message:"Une erreur est survenue lors de la mise à jour",type:"error",isLoading:!1,autoClose:3e3})}finally{p.dismiss(N)}};return e.jsxs(e.Fragment,{children:[e.jsx(f,{type:"button",onClick:()=>n(!0),children:e.jsx(fe,{})}),b&&e.jsxs(l,{show:b,onHide:c,centered:!0,size:"lg",children:[e.jsx(l.Header,{closeButton:!0,children:e.jsx(l.Title,{children:"Modifier le quartier/village"})}),e.jsxs(t,{onSubmit:m(x),children:[e.jsxs(l.Body,{className:"p-4",children:[e.jsxs("div",{className:"form-group mb-3",children:[e.jsx("label",{htmlFor:"name",children:"Nom"}),e.jsx("input",{id:"name",className:"form-control my-2",...v("name",{required:"Ce champ est requis"})}),h.name&&e.jsx("div",{className:"text-danger",children:h.name.message})]}),a==="failed"&&e.jsx("p",{className:"text-danger",children:"Une erreur est survenue !"})]}),e.jsxs(l.Footer,{className:"border-0 justify-content-between",children:[e.jsx(f,{variant:"danger",type:"button",onClick:c,children:"Annuler"}),e.jsx(f,{variant:"primary",type:"submit",className:"px-4",children:a==="loading"?e.jsx(B,{animation:"border",size:"sm"}):"Enregistrer"})]})]})]})]})},Fe=({selectedVillages:r,villageNames:E,onClose:b,show:n})=>{const[u,a]=i.useState(""),[v,m]=i.useState(""),[j,h]=i.useState([]),[c,x]=i.useState(!1),[g,w]=i.useState(!1),[V,N]=i.useState(!1),{user:C}=ve();i.useEffect(()=>{n&&q()},[n]),i.useEffect(()=>{n||(N(!1),a(""),m(""))},[n]);const q=async()=>{x(!0);try{const o=await fetch("http://plaintes.celluleinfra.org:8181/api/v1/committees",{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error("Erreur lors du chargement des comités");const S=await o.json(),y=S.data?S.data:S;h(y)}catch(o){p.error(o instanceof Error?o.message:"Erreur lors du chargement des comités")}finally{x(!1)}},H=async o=>{if(o.preventDefault(),!u){p.error("Veuillez sélectionner un comité");return}const S=C==null?void 0:C.token;w(!0);try{const y=await fetch(`http://plaintes.celluleinfra.org:8181/api/v1/villages/add-to-committee/${u}?ids=${r.join(",")}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`}});if(!y.ok){const F=await y.json();throw new Error(F.message||"Erreur lors de l'affectation des villages/quartiers au comité")}p.success("Villages/Quartiers affectés au comité avec succès"),b()}catch(y){p.error(y instanceof Error?y.message:"Une erreur est survenue lors de l'affectation")}finally{w(!1)}},z=o=>{const S=o.target.value;if(a(S),S){const y=j.find(F=>F.id===S);m(y?y.name:"")}else m("")},D=o=>{if(o.preventDefault(),!u){p.error("Veuillez sélectionner un comité");return}N(!0)},I=()=>{N(!1)},A=E.filter(o=>r.includes(o.id));return e.jsxs(l,{show:n,onHide:b,centered:!0,children:[e.jsx(l.Header,{closeButton:!0,children:e.jsx(l.Title,{children:V?"Confirmer l'affectation":"Affecter à un comité"})}),V?e.jsxs(t,{onSubmit:H,children:[e.jsxs(l.Body,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Comité sélectionné:"}),e.jsx(Le,{bg:"primary",className:"fs-6 p-2",children:v})]}),e.jsxs("div",{children:[e.jsxs("h6",{className:"mb-2",children:["Villages/Quartiers à affecter (",A.length,"):"]}),e.jsx(te,{className:"mb-3",style:{maxHeight:"200px",overflowY:"auto"},children:A.map(o=>e.jsx(te.Item,{className:"d-flex justify-content-between align-items-center",children:o.name},o.id))})]}),e.jsxs("div",{className:"alert alert-warning",children:[e.jsx("strong",{children:"Attention:"}),' Cette action affectera les villages/quartiers sélectionnés au comité "',v,'". Voulez-vous continuer?']})]}),e.jsxs(l.Footer,{children:[e.jsxs(f,{variant:"outline-secondary",onClick:I,children:[e.jsx(Se,{className:"me-2"}),"Retour"]}),e.jsx(f,{variant:"secondary",onClick:b,children:"Annuler"}),e.jsx(f,{variant:"success",type:"submit",disabled:g,children:g?e.jsxs(e.Fragment,{children:[e.jsx(B,{animation:"border",size:"sm",className:"me-2"}),"Affectation..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"me-2"}),"Confirmer l'affectation"]})})]})]}):e.jsxs(t,{onSubmit:D,children:[e.jsxs(l.Body,{children:[e.jsxs("p",{children:["Vous avez sélectionné ",r.length," village(s)/quartier(s)"]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Sélectionner un comité"}),c?e.jsx("div",{className:"text-center",children:e.jsx(B,{animation:"border",size:"sm"})}):e.jsxs(t.Select,{value:u,onChange:z,required:!0,children:[e.jsx("option",{value:"",children:"-- Sélectionner un comité --"}),j.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]})]}),e.jsxs(l.Footer,{children:[e.jsx(f,{variant:"secondary",onClick:b,children:"Annuler"}),e.jsx(f,{variant:"primary",type:"submit",disabled:!u||c,children:"Continuer"})]})]})]})};function Me(){var Z;const r=Q(),[E,b]=i.useState(!1),[n,u]=i.useState(""),[a,v]=i.useState(""),[m,j]=i.useState(""),[h,c]=i.useState(""),[x,g]=i.useState([]),[w,V]=i.useState(!1),[N,C]=i.useState([]),[q,H]=i.useState("province"),{provinces:z}=L(s=>s.province),{territories:D}=L(s=>s.territory),{cities:I}=L(s=>s.Villes),{sectors:A}=L(s=>s.sectors),{villages:o,status:S,error:y}=L(s=>s.villages),[F,ne]=i.useState([]),ae=async()=>{try{const s=await fetch("http://plaintes.celluleinfra.org:8181/api/v1/committees",{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error("Erreur lors du chargement des comités");const d=await s.json(),k=d.data?d.data:d;C(k)}catch(s){p.error(s instanceof Error?s.message:"Erreur lors du chargement des comités")}finally{}},{register:M,handleSubmit:ie,reset:W,formState:{errors:X,isSubmitting:Y}}=U({resolver:J(Ae)}),ce=async()=>{try{const s=await fetch("http://plaintes.celluleinfra.org:8181/api/v1/project-site",{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error("Erreur lors du chargement des project-sites");const d=await s.json();ne(d)}catch(s){p.error(s instanceof Error?s.message:"Erreur lors du chargement des project-sites")}};i.useEffect(()=>{r(Ce()),ce(),ae()},[r]),i.useEffect(()=>{!a||!n||(n==="rural"?r(_({id:a})):n==="urbain"&&r(ee({id:a})))},[r,a,n]),i.useEffect(()=>{m&&n==="urbain"&&r(Ne({id:m})),m&&n==="rural"&&r(we({id:m}))},[r,m]),i.useEffect(()=>{h&&r(ke({id:h}))},[r,h]);const R=z.find(s=>s.id===a),oe=(R==null?void 0:R.isProjectConcern)??!1,K=()=>{b(!1),W(),v(""),u(""),j(""),c("")},le=async s=>{const d={name:s.name,sector:h,projectSite:s.projectSite,commitee:s.commitee};console.log();const k=p.loading("Veuillez patienter...");try{await r(Ve(d)).unwrap(),p.update(k,{render:"Quartier/Village ajouté avec succès",type:"success",isLoading:!1,autoClose:2e3}),K()}catch(P){p.update(k,{render:String(P),type:"error",isLoading:!1,autoClose:3e3})}},de=s=>{g(d=>d.includes(s)?d.filter(k=>k!==s):[...d,s])},ue=()=>{var P;const d=(((P=A.find(G=>G.id===h))==null?void 0:P.villages)||[]).map(G=>G.id),k=d.every(G=>x.includes(G));g(k?[]:d)},O=()=>{x.length===0?p.warning("Veuillez sélectionner au moins un village/quartier"):V(!0)},me=()=>V(!1),$=A.find(s=>s.id===h),T=($==null?void 0:$.villages)||[],he=T.length>0&&T.every(s=>x.includes(s.id));return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-between mb-3",children:[e.jsx("span",{className:"fs-4",children:"Liste des quartiers/villages"}),e.jsxs("div",{className:"d-flex gap-2",children:[oe?e.jsxs(f,{variant:"success",onClick:O,disabled:x.length===0,className:"w-auto text-center",children:[e.jsx(se,{className:"me-2"}),"Ajouter dans un comité (",x.length,")"]}):e.jsxs(f,{variant:"success",onClick:O,disabled:!0,className:"w-auto text-center",children:[e.jsx(se,{className:"me-2"}),"Impossible d'Ajouter au commité (province non adérée)"]}),e.jsx(f,{onClick:()=>b(!0),children:"Ajouter"})]})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Mode de filtrage"}),e.jsxs(t.Select,{value:q,onChange:s=>{const d=s.target.value;H(d),d==="committee"?(v(""),u(""),j(""),c("")):W({commitee:""})},children:[e.jsx("option",{value:"province",children:"Filtrer par province"}),e.jsx("option",{value:"committee",children:"Filtrer par comité"})]})]}),q==="committee"?e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Sélectionner un comité (optionnel)"}),e.jsxs(t.Select,{...M("commitee"),children:[e.jsx("option",{value:"",children:"-- Sélectionner un comité --"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}):e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Choisir une province"}),e.jsxs(t.Select,{value:a,onChange:s=>{v(s.target.value),u(""),j(""),c("")},children:[e.jsx("option",{value:"",children:"-- Sélectionnez une province --"}),z.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),a&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Plus petite entitee"}),e.jsxs("div",{className:"d-flex gap-3",children:[e.jsx(t.Check,{type:"radio",label:"Rural",name:"type",value:"rural",checked:n==="rural",onChange:()=>{u("rural"),j(""),c("")}}),e.jsx(t.Check,{type:"radio",label:"Urbain",name:"type",value:"urbain",checked:n==="urbain",onChange:()=>{u("urbain"),j(""),c("")}})]})]}),n&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:n==="urbain"?"Choisir une ville":"Choisir un territoire"}),e.jsxs(t.Select,{value:m,onChange:s=>{j(s.target.value),c("")},children:[e.jsxs("option",{value:"",children:["-- Sélectionnez un",n==="rural"?" territoire":"e ville","--"]}),n==="urbain"?I.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):D.map(s=>e.jsx("option",{value:s.id||"",children:s.name},s.id))]})]}),m&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsxs(t.Label,{children:["Choisir un",n==="rural"?" secteur":"e commune"]}),e.jsxs(t.Select,{value:h,onChange:s=>c(s.target.value),children:[e.jsxs("option",{value:"",children:["-- Sélectionnez un",n==="rural"?" secteur":"e commune"," --"]}),A.map(s=>e.jsx("option",{value:s.id||"",children:s.name},s.id))]})]}),e.jsxs(Ee,{striped:!0,bordered:!0,hover:!0,children:[e.jsx("thead",{className:"table-dark",children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40px"},children:e.jsx("input",{type:"checkbox",checked:he,onChange:ue,disabled:T.length===0})}),e.jsx("th",{children:"#"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Comité"}),e.jsx("th",{children:"Action"})]})}),e.jsxs("tbody",{children:[S==="loading"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:e.jsx(B,{animation:"border",size:"sm"})})}),S==="failed"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-danger text-center",children:y})}),h?T.length>0?T.map((s,d)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("input",{type:"checkbox",checked:x.includes(s.id),onChange:()=>de(s.id)})}),e.jsx("td",{children:d+1}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.committeeName||"Non affecté"}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-2 justify-content-center",children:[e.jsx(ze,{dispashing:()=>{n==="rural"?(r(_({id:a})),console.log("idProvince",a),console.log("type",n)):n==="urbain"&&(r(ee({id:a})),console.log("idProvince",a),console.log("type",n))},village:{id:s.id,name:(s==null?void 0:s.name)||"",sector:h}}),e.jsx(Te,{id:s.id,name:(s==null?void 0:s.name)||""})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:"Aucun village/quartier trouvé"})}):e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:"Veuillez sélectionner une commune"})})]})]}),e.jsxs(l,{show:E,onHide:K,centered:!0,children:[e.jsx(l.Header,{closeButton:!0,children:e.jsx(l.Title,{children:"Ajouter un quartier/village"})}),e.jsx(l.Body,{children:e.jsxs("form",{onSubmit:ie(le),children:[e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Nom"}),e.jsx(t.Control,{...M("name"),isInvalid:!!X.name}),e.jsx(t.Control.Feedback,{type:"invalid",children:(Z=X.name)==null?void 0:Z.message})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Projet Site (optionnel)"}),e.jsxs(t.Select,{...M("projectSite"),children:[e.jsx("option",{value:"",children:"-- Aucun projet site --"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Sélectionner un comité (optionnel)"}),e.jsxs(t.Select,{...M("commitee"),children:[e.jsx("option",{value:"",children:"-- Sélectionner un comité --"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Choisir une province"}),e.jsxs(t.Select,{value:a,onChange:s=>{v(s.target.value),u(""),j(""),c("")},children:[e.jsx("option",{value:"",children:"-- Sélectionnez une province --"}),z.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),a&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Plus petite entitee"}),e.jsxs("div",{className:"d-flex gap-3",children:[e.jsx(t.Check,{type:"radio",label:"Rural",name:"type",value:"rural",checked:n==="rural",onChange:()=>{u("rural"),j(""),c("")}}),e.jsx(t.Check,{type:"radio",label:"Urbain",name:"type",value:"urbain",checked:n==="urbain",onChange:()=>{u("urbain"),j(""),c("")}})]})]}),n&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:n==="urbain"?"Choisir une ville":"Choisir un territoire"}),e.jsxs(t.Select,{value:m,onChange:s=>{j(s.target.value),c("")},children:[e.jsx("option",{value:"",children:"-- Sélectionnez --"}),n==="urbain"?I.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):D.map(s=>e.jsx("option",{value:s.id||"",children:s.name},s.id))]})]}),m&&e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Choisir une commune"}),e.jsxs(t.Select,{value:h,onChange:s=>c(s.target.value),children:[e.jsx("option",{value:"",children:"-- Sélectionnez une commune --"}),A.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsx(f,{variant:"primary",type:"submit",disabled:Y||!h,children:Y?"Enregistrement...":"Enregistrer"})]})})]}),e.jsx(Fe,{selectedVillages:x,villageNames:T.filter(s=>x.includes(s.id)).map(s=>({id:s.id,name:s.name||""})),show:w,onClose:()=>{me(),g([])}})]})}export{Me as default};
