import{a as U,d as V,o as J,b as q,j as e,x as c,H as fe,D as a,z as R,F as t,I as Ce,J as Se,K as Ne,r as d,m as we,q as Te,N as ke,O as re,y as $,n as f,Q as De}from"./index-CyHwfVtD.js";import{u as O,w as Ae}from"./xlsx-BiIUQI8q.js";import{P as E}from"./Pagination-CzSzWT8f.js";import"./Anchor-DlW4iPnB.js";const ae=[{value:1,label:"Comité"},{value:2,label:"ONG"},{value:3,label:"Entreprise"},{value:4,label:"Mission Contrôle"}],Ee=({id:o,currentName:h,type:u})=>{const[j,C]=U.useState(!1),S=V(),{register:y,handleSubmit:N,reset:p,setError:F,formState:{errors:l}}=J({defaultValues:{id:o,name:h,type:u}}),{updateStatus:b}=q(n=>n.committee);q(n=>n.groupCommitees);const i=async n=>{try{await S(Ce(n)).unwrap(),v()}catch(w){F("type",{message:String(w)})}},v=()=>{C(!1)};return U.useEffect(()=>{b==="succeeded"&&(v(),p({id:o,name:h}))},[b]),e.jsxs(e.Fragment,{children:[e.jsx(c,{type:"button",variant:"primary",onClick:()=>C(!0),children:e.jsx(fe,{})}),j&&e.jsxs(a,{show:j,onHide:v,centered:!0,children:[e.jsx(a.Header,{closeButton:!0,children:e.jsxs(a.Title,{children:["Modifier la Comité ",b==="loading"&&e.jsx(R,{animation:"border"})]})}),e.jsxs(t,{onSubmit:N(i),children:[e.jsxs(a.Body,{className:"p-4",children:[e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Type"}),e.jsx("div",{className:"d-flex gap-2",children:ae.map(n=>e.jsx("div",{className:"d-flex align-items-center",children:e.jsx(t.Check,{type:"radio",label:n.label,value:n.value,...y("type",{required:!0}),defaultChecked:u===n.value,className:"me-2",style:{display:"flex",alignItems:"center"}})},n.value))}),l.type&&e.jsx("span",{className:"text-danger",children:"Ce champ est requis"})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Nom du Comité"}),e.jsx(t.Control,{type:"text",defaultValue:h,...y("name",{required:!0})}),l.name&&e.jsx("span",{className:"text-danger",children:"Ce champ est requis"})]}),e.jsxs(t.Group,{controlId:"group",className:"mb-3",children:[e.jsx(t.Label,{children:"Type"}),e.jsxs(t.Control,{as:"select",defaultValue:u,...y("type"),required:!0,children:[e.jsx("option",{value:"",children:"Sélectionnez un type"}),ae.map((n,w)=>e.jsx("option",{value:n.value,children:n.label},w))]})]})]}),e.jsx(a.Footer,{children:e.jsxs("div",{className:"d-flex align-items-center gap-3 justify-content-end",children:[e.jsx(c,{variant:"outline-secondary",onClick:v,type:"button",children:"Annuler"}),e.jsx(c,{variant:"primary",type:"submit",children:"Modifier"})]})})]})]})]})},Fe=({id:o,name:h})=>{const[u,j]=U.useState(!1),C=V(),{register:S,handleSubmit:y,setError:N,formState:{errors:p}}=J(),{deleteStatus:F}=q(i=>i.committee),l=async i=>{try{await C(Ne({id:o,reason:i.reason})).unwrap(),b()}catch(v){N("reason",{message:String(v)})}},b=()=>{j(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(c,{type:"button",variant:"danger",onClick:()=>j(!0),children:e.jsx(Se,{})}),u&&e.jsxs(a,{show:u,onHide:b,centered:!0,children:[e.jsx(a.Header,{closeButton:!0,children:e.jsxs(a.Title,{children:["Suprimer la Comité ",F==="loading"&&e.jsx(R,{size:"sm",animation:"border"})]})}),e.jsxs(t,{onSubmit:y(l),children:[e.jsxs(a.Body,{className:"p-4",children:[e.jsx("p",{children:"Confirmer la suppression du Comité ?"}),e.jsx("p",{children:h}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Raison"}),e.jsxs(t.Select,{...S("reason",{required:"Ce champs est requies"}),children:[e.jsx("option",{value:"",children:"-- Choisir --"}),e.jsx("option",{value:"Bad data",children:"Données erronées"}),e.jsx("option",{value:"Data created by mistake and more",children:"Données créées par erreur"})]}),p.reason&&e.jsx("span",{className:"text-danger",children:p.reason.message})]})]}),e.jsx(a.Footer,{children:e.jsxs("div",{className:"d-flex align-items-center gap-3 justify-content-end",children:[e.jsx(c,{variant:"outline-secondary",onClick:b,type:"button",children:"Annuler"}),e.jsx(c,{variant:"danger",type:"submit",children:"Supprimer"})]})})]})]})]})},_=[{value:1,label:"Comité"},{value:2,label:"ONG"},{value:3,label:"Entreprise"},{value:4,label:"Mission Contrôle"}],ne=o=>{if(!o)return"Comité";const h=_.find(u=>u.value===o);return h?h.label:"Inconnu"};function Ie(){var Z;const{register:o,handleSubmit:h,reset:u,formState:{errors:j}}=J(),[C,S]=d.useState(!1),[y,N]=d.useState(!1),[p,F]=d.useState(""),[l,b]=d.useState(0),[i,v]=d.useState(null),[n,w]=d.useState(""),[B,K]=d.useState(""),[r,Q]=d.useState(null),[le,ie]=d.useState([]),[T,ce]=d.useState(1),{committees:g,status:I,error:de,createStatus:W}=q(s=>s.committee);q(s=>s.groupCommitees);const{user:z}=we(),k=V(),oe=Te(),P=12,he=()=>{var se;if(!((se=g==null?void 0:g.data)!=null&&se.length)){f.warning("Aucune donnée à exporter.");return}const s=g.data.map((M,ve)=>{var te;return{"#":ve+1,Nom:M.name,Type:ne(Number(M.type)??null),Localisation:(te=M.villages)==null?void 0:te.map(ye=>ye.name).join(", ")}}),x=O.json_to_sheet(s),m=O.book_new();O.book_append_sheet(m,x,"Comités");const A=Ae(m,{type:"array",bookType:"xlsx"}),ge=new Blob([A],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),ee=URL.createObjectURL(ge),G=document.createElement("a");G.href=ee,G.download="comites.xlsx",document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(ee)},ue=async()=>{try{const s=await fetch("https://plaintes.celluleinfra.org:8181/api/v1/project-site");if(!s.ok)throw new Error("Erreur chargement project-sites");const x=await s.json();ie(x)}catch(s){f.error(s.message??"Erreur de connexion")}},xe=()=>S(!0),H=()=>{S(!1),u()},X=()=>{N(!1),Q(null),w(""),K("")},me=async s=>{if(!n||!B){f.error("Sélectionnez une période valide");return}try{const m=await(await fetch(`https://plaintes.celluleinfra.org:8181/api/v1/committees/repport/${s}?startDate=${n}&endDate=${B}`,{headers:{Authorization:`Bearer ${z==null?void 0:z.token}`}})).json();Q(m)}catch{f.error("Erreur récupération rapport")}},je=async s=>{const x={...s,group:s.group||void 0,site:s.projectSiteId||void 0},m=f.loading("Enregistrement...");try{await k(De(x)).unwrap(),f.update(m,{render:"Comité créé 🎉",type:"success",isLoading:!1,autoClose:2e3}),H(),k(re({pageSize:P,currentPage:l,filter:p,type:T?Number(T):void 0}))}catch(A){f.update(m,{render:A.message??String(A),type:"error",isLoading:!1,autoClose:3e3})}};d.useEffect(()=>{k(ke()),ue()},[k]),d.useEffect(()=>{k(re({pageSize:P,currentPage:l,filter:p,type:T?Number(T):void 0}))},[k,l,p,T]);const D=Math.ceil(Number(g==null?void 0:g.totalItems)/P),L=s=>{b(s),oe(`?page=${s}`)},Y=5,pe=Math.max(0,l-Math.floor(Y/2)),be=Array.from({length:Math.min(Y,D)},(s,x)=>pe+x).filter(s=>s<D);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-between mb-4",children:[e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(t.Control,{placeholder:"Rechercher comité",className:"w-25",value:p,onChange:s=>F(s.target.value)}),e.jsx(t.Select,{style:{width:"200px"},value:T??"",onChange:s=>ce(s.target.value?Number(s.target.value):null),children:_.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(c,{variant:"outline-primary",onClick:xe,children:"Ajouter un comité"}),e.jsx(c,{variant:"success",onClick:he,children:"Exporter Excel"})]})]}),e.jsxs($,{bordered:!0,hover:!0,striped:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Localisation"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"Détails"})]})}),e.jsxs("tbody",{children:[I==="loading"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center",children:e.jsx(R,{})})}),I==="failed"&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-danger text-center",children:de})}),I==="succeeded"&&g.data.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"text-center",children:"Aucun comité trouvé"})}),I==="succeeded"&&g.data.map((s,x)=>{var m;return e.jsxs("tr",{children:[e.jsx("td",{children:x+1+l*P}),e.jsx("td",{children:s.name}),e.jsx("td",{children:ne(Number(s.type)??null)}),e.jsx("td",{children:s.groupName}),e.jsx("td",{children:(m=s.villages)==null?void 0:m.map(A=>A.name).join(", ")}),e.jsxs("td",{className:"d-flex gap-2",children:[e.jsx(Ee,{id:s.id,currentName:s.name,type:Number(s.type)??0}),e.jsx(Fe,{id:s.id,name:s.name})]}),e.jsx("td",{children:e.jsx(c,{variant:"info",size:"sm",onClick:()=>{v(s),N(!0)},children:"Voir"})})]},s.id)})]})]}),D>1&&e.jsxs(E,{children:[e.jsx(E.First,{onClick:()=>L(0),disabled:l===0}),e.jsx(E.Prev,{onClick:()=>L(l-1),disabled:l===0}),be.map(s=>e.jsx(E.Item,{active:s===l,onClick:()=>L(s),children:s+1},s)),e.jsx(E.Next,{onClick:()=>L(l+1),disabled:l>=D-1}),e.jsx(E.Last,{onClick:()=>L(D-1),disabled:l>=D-1})]}),e.jsxs(a,{show:C,onHide:H,centered:!0,children:[e.jsx(a.Header,{closeButton:!0,children:e.jsx(a.Title,{children:"Ajouter un comité"})}),e.jsx(a.Body,{children:e.jsxs(t,{onSubmit:h(je),children:[e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Type *"}),e.jsx("div",{className:"d-flex gap-3",children:_.map(s=>e.jsx(t.Check,{type:"radio",label:s.label,...o("type",{required:!0}),value:s.value},s.value))}),j.type&&e.jsx("div",{className:"text-danger",children:"Ce champ est requis"})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Nom *"}),e.jsx(t.Control,{type:"text",...o("name",{required:!0}),isInvalid:!!j.name}),e.jsx(t.Control.Feedback,{type:"invalid",children:"Ce champ est requis"})]}),e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"Projet Site *"}),e.jsxs(t.Select,{...o("projectSiteId",{required:!0}),isInvalid:!!j.projectSiteId,children:[e.jsx("option",{value:"",children:"-- Sélectionnez un site --"}),le.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx(t.Control.Feedback,{type:"invalid",children:"Requis"})]}),e.jsxs("div",{className:"text-end",children:[e.jsx(c,{variant:"secondary",onClick:H,className:"me-2",children:"Annuler"}),e.jsx(c,{type:"submit",disabled:W==="loading",children:W==="loading"?e.jsxs(e.Fragment,{children:[e.jsx(R,{size:"sm",animation:"border"})," Enregistrement..."]}):"Enregistrer"})]})]})})]}),e.jsxs(a,{show:y,onHide:X,centered:!0,size:"lg",children:[e.jsx(a.Header,{closeButton:!0,children:e.jsxs(a.Title,{children:["Détails des plaintes du comité ",i==null?void 0:i.name]})}),e.jsxs(a.Body,{children:[e.jsxs("div",{className:"d-flex gap-3 mb-3",children:[e.jsx(t.Control,{type:"date",value:n,onChange:s=>w(s.target.value)}),e.jsx(t.Control,{type:"date",value:B,onChange:s=>K(s.target.value)}),e.jsx(c,{onClick:()=>(i==null?void 0:i.id)&&me(i.id),disabled:!n||!B,children:"Charger"})]}),r?e.jsxs(e.Fragment,{children:[e.jsx("h5",{children:"Statistiques"}),e.jsxs($,{bordered:!0,striped:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Catégorie"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Traitées"}),e.jsx("th",{children:"Non traitées"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Plaintes générales"}),e.jsx("td",{children:r.complaintsGenerales}),e.jsxs("td",{children:[r.complaintsGeneralesTraites," ",e.jsxs("small",{children:["(",r.complaintsGeneralesTraitesDelais," dans les délais)"]})]}),e.jsxs("td",{children:[r.complaintsGeneralesNonTraites," ",e.jsxs("small",{children:["(",r.complaintsGeneralesNonTraitesDelais," hors délais)"]})]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Plaintes sensibles"}),e.jsx("td",{children:r.complaintsSensibles}),e.jsxs("td",{children:[r.complaintsSensiblesTraites," ",e.jsxs("small",{children:["(",r.complaintsSensiblesTraitesDelais," dans les délais)"]})]}),e.jsxs("td",{children:[r.complaintsSensiblesNonTraites," ",e.jsxs("small",{children:["(",r.complaintsSensiblesNonTraitesDelais," hors délais)"]})]})]}),e.jsxs("tr",{className:"table-primary",children:[e.jsx("td",{children:e.jsx("strong",{children:"Total général"})}),e.jsx("td",{children:r.complaints}),e.jsxs("td",{children:[r.complaintsTraites," ",e.jsxs("small",{children:["(",r.complaintsTraitesDelais," dans les délais)"]})]}),e.jsxs("td",{children:[r.complaintsNonTraites," ",e.jsxs("small",{children:["(",r.complaintsNonTraitesDelais," hors délais)"]})]})]})]})]}),e.jsx("h5",{children:"Infos du comité"}),e.jsx($,{bordered:!0,children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Référence"})}),e.jsx("td",{children:r.referenceNumber})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Groupe"})}),e.jsx("td",{children:r.groupName??"Aucun"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Site projet"})}),e.jsx("td",{children:r.siteName??"Aucun"})]}),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:"Villages"})}),e.jsx("td",{children:(Z=r.villages)==null?void 0:Z.map(s=>s.name).join(", ")})]})]})})]}):e.jsx("div",{className:"text-center text-muted",children:"Aucun rapport chargé."})]}),e.jsx(a.Footer,{children:e.jsx(c,{variant:"secondary",onClick:X,children:"Fermer"})})]})]})}export{Ie as default};
