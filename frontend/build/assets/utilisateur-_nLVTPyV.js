import{r as a,m as Ae,o as Ge,b as Ie,q as Ee,s as Pe,d as Fe,t as Te,v as Ue,w as z,j as e,F as t,x as y,R as S,y as Me,z as $,D as h,C as c,E as Be}from"./index-BBwNWda_.js";import{C as Re}from"./customToast-N5PhD1Lp.js";import{u as D,w as ze}from"./xlsx-BiIUQI8q.js";import{P as L}from"./Pagination-Dr02RiN_.js";import"./Anchor-B_1sJziF.js";function Qe(){var Z,ee,se,te,re,ie,ne,oe,ae,le;const[C,E]=a.useState([]),[ce,O]=a.useState(!1),[F,_]=a.useState(null),{user:T}=Ae(),[de,ue]=a.useState([]);a.useState([]);const[w,q]=a.useState([]),{register:d,handleSubmit:me,reset:H,formState:{errors:o}}=Ge(),[he,V]=a.useState(!1),[pe,xe]=a.useState([]),[$e,je]=a.useState([]),[A,ge]=a.useState(""),[ve,p]=a.useState(!1),[be,j]=a.useState(""),[u,P]=a.useState(1),[fe,g]=a.useState("success"),{isLoading:v,managers:b,currentPage:De,totalItems:Y}=Ie(s=>s.manager),Q=Ee(),J=Pe(),G=Fe(),ye=async()=>{try{const s=await fetch("https://plaintes.celluleinfra.org/api/v1/project-site",{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error("Erreur lors du chargement des project-sites");const i=await s.json();ue(i)}catch(s){j(s instanceof Error?s.message:"Erreur lors du chargement des project-sites"),g("error"),p(!0)}},Ce=()=>{const s=b.map((f,qe)=>({"#":X(qe),Nom:f.lastName,"Post Nom":f.middleName,Prénom:f.firstName,Comité:f.committeeName||"-",Rôle:f.role,Levels:Array.isArray(f.trakingLevel)?f.trakingLevel.join(", "):"-"})),i=D.json_to_sheet(s),n=D.book_new();D.book_append_sheet(n,i,"Utilisateurs");const l=ze(n,{bookType:"xlsx",type:"array"}),x=new Blob([l],{type:"application/octet-stream"}),m=window.URL.createObjectURL(x),R=document.createElement("a");R.href=m,R.download="utilisateurs.xlsx",R.click(),window.URL.revokeObjectURL(m)};a.useEffect(()=>{ye(),Te().then(s=>{const i=Array.isArray(s.committees)?s.committees:[];xe(i),console.log("committees",i)}).catch(s=>{console.error("Failed to fetch committees:",s)}),Ue().then(s=>{const i=Array.isArray(s)?s:[];je(i)}).catch(s=>{console.error("Failed to fetch group committees:",s)})},[]);const N=12;a.useEffect(()=>{G(z({pageSize:N,currentPage:u,filter:A}))},[G,u,A,N]),a.useEffect(()=>{const i=new URLSearchParams(J.search).get("page");i&&!isNaN(Number(i))?P(Number(i)):i===null&&P(1)},[J.search]);const k=Math.ceil(Y/N),I=s=>{s>=1&&s<=k&&(Q(`?page=${s}`),P(s))},K=s=>{const i=C.includes(s)?C.filter(n=>n!==s):[...C,s];E(i)},Ne=s=>{_(s);const i=b.find(n=>n.id===s);i&&i.trakingLevel&&Array.isArray(i.trakingLevel)?E(i.trakingLevel.map(n=>Number(n))):E([]),O(!0)},ke=async()=>{if(F===null){j("Aucun utilisateur sélectionné."),g("error"),p(!0);return}const s=T==null?void 0:T.token,i=`levels=${C.join(",")}`,n=`https://plaintes.celluleinfra.org/api/v1/users/update-traking-access/${F}?${i}`;try{const l=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!l.ok){let x=`Erreur lors de la mise à jour (status: ${l.status})`;try{const m=await l.json();x=(m==null?void 0:m.message)||(m==null?void 0:m.error)||x}catch{}throw new Error(x)}j("Accès mis à jour avec succès!"),g("success"),p(!0),B(),G(z({pageSize:N,currentPage:u,filter:A}))}catch(l){console.error("Update use case error:",l),j(l instanceof Error?l.message:"Échec de la mise à jour"),g("error"),p(!0)}},[r,U]=a.useState(""),W=s=>{const i=new Date(s),n=new Date;let l=n.getFullYear()-i.getFullYear();const x=n.getMonth()-i.getMonth();return(x<0||x===0&&n.getDate()<i.getDate())&&l--,l},Se=s=>{q(r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg"?[s]:i=>i.includes(s)?i.filter(n=>n!==s):[...i,s])},Le=async s=>{if(s.dateOfBirth&&W(s.dateOfBirth)<18){p(!0),j("L'utilisateur doit avoir au moins 18 ans"),g("error");return}const i={...s,committee:(r==="committee"||r==="manager"||r==="ong")&&s.committee?s.committee:void 0,committeeGroup:r==="committee_group"&&s.committeeGroup?s.committeeGroup:void 0,sites:(r==="eds-vbg"||r==="eds-pg"||r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg"||r==="ci-vbg"||r==="ci-pg")&&w.length>0?w.join(","):void 0,role:r};try{await G(Be(i)).unwrap(),p(!0),j("Gestionnaire créé avec succès !"),g("success"),H(),U(""),q([]),setTimeout(()=>{M()},1e3),G(z({pageSize:N,currentPage:u,filter:A}))}catch(n){p(!0),j(String(n)),g("error")}},X=s=>(u-1)*N+s+1,we=()=>V(!0),M=()=>{V(!1),H(),U(""),q([])},B=()=>{O(!1),_(null),E([])};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"d-flex flex-column flex-md-row gap-2 gap-md-0 justify-content-md-between mb-5",children:[e.jsx("div",{className:"w-md-25",children:e.jsx(t.Control,{type:"text",placeholder:"Rechercher un utilisateur","aria-label":"Rechercher",value:A,onChange:s=>{ge(s.target.value),P(1),Q("?page=1")}})}),e.jsx(y,{variant:"outline-primary",className:"me-2 w-md-auto",onClick:we,children:"Ajouter un utilisateur"}),e.jsx(y,{variant:"success",className:"ms-2",onClick:Ce,children:"Exporter en Excel"})]}),e.jsx(S,{children:e.jsxs("div",{children:[e.jsxs(Me,{striped:!0,bordered:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-center",children:"#"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Post Nom"}),e.jsx("th",{children:"Prénom"}),e.jsx("th",{children:"Comité"}),e.jsx("th",{children:"Rôle"}),e.jsx("th",{className:"text-center",children:"Levels"}),e.jsx("th",{className:"text-center",children:"Actions"})]})}),!v&&b&&b.length>0&&e.jsx("tbody",{children:b.map((s,i)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-center",children:X(i)}),e.jsx("td",{children:s.lastName}),e.jsx("td",{children:s.middleName}),e.jsx("td",{children:s.firstName}),e.jsx("td",{children:s.committeeName?s.committeeName:"-"}),e.jsx("td",{children:s.role}),e.jsx("td",{className:"text-center",children:Array.isArray(s==null?void 0:s.trakingLevel)&&s.trakingLevel.length>0?e.jsx("ul",{className:"mb-0",children:s.trakingLevel.filter(n=>typeof n=="number").map((n,l)=>e.jsx("li",{children:`Étape : ${n}`},l))}):"-"}),e.jsx("td",{className:"text-center",children:e.jsx(y,{variant:"outline-success",size:"sm",onClick:()=>(s==null?void 0:s.id)&&Ne(s.id),disabled:!s.id,children:"Modifier accès"})})]},s.id||i))})]}),v&&e.jsxs("div",{className:"text-center w-100 py-5",children:[e.jsx($,{className:"text-primary",as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"}),e.jsx("p",{children:"Chargement des utilisateurs..."})]}),!v&&(!b||b.length===0)&&e.jsx("p",{className:"text-center py-5",children:"Aucun utilisateur trouvé."})]})}),Y>0&&k>1&&e.jsx("div",{className:"d-flex justify-content-end mt-3",children:e.jsxs(L,{className:"mb-0",children:[e.jsx(L.First,{onClick:()=>I(1),disabled:u===1}),e.jsx(L.Prev,{onClick:()=>I(u-1),disabled:u===1}),[...Array(k).keys()].map(s=>e.jsx(L.Item,{active:s+1===u,onClick:()=>I(s+1),children:s+1},s+1)),e.jsx(L.Next,{onClick:()=>I(u+1),disabled:u===k}),e.jsx(L.Last,{onClick:()=>I(k),disabled:u===k})]})})]}),e.jsxs(h,{show:he,onHide:M,centered:!0,size:"lg",backdrop:"static",children:[e.jsx(h.Header,{closeButton:!0,children:e.jsx(h.Title,{children:"Ajouter un utilisateur"})}),e.jsx(h.Body,{children:e.jsxs(t,{onSubmit:me(Le),children:[e.jsxs(S,{className:"mb-3",children:[e.jsxs(t.Group,{as:c,md:"4",controlId:"lastName",children:[e.jsx(t.Label,{children:"Nom"}),e.jsx(t.Control,{...d("lastName",{required:"Le nom est requis"}),isInvalid:!!o.lastName,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(Z=o.lastName)==null?void 0:Z.message})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"middleName",children:[e.jsx(t.Label,{children:"Post Nom"}),e.jsx(t.Control,{...d("middleName")})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"firstName",children:[e.jsx(t.Label,{children:"Prénom"}),e.jsx(t.Control,{...d("firstName",{required:"Le prénom est requis"}),isInvalid:!!o.firstName,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(ee=o.firstName)==null?void 0:ee.message})]})]}),e.jsxs(S,{className:"mb-3",children:[e.jsxs(t.Group,{as:c,md:"4",controlId:"dateOfBirth",children:[e.jsx(t.Label,{children:"Date de naissance"}),e.jsx(t.Control,{type:"date",...d("dateOfBirth",{required:"La date de naissance est requise",validate:{validAge:s=>s?W(s)>=18||"L'utilisateur doit avoir au moins 18 ans":!0}}),isInvalid:!!o.dateOfBirth,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(se=o.dateOfBirth)==null?void 0:se.message})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"gender",children:[e.jsx(t.Label,{children:"Genre"}),e.jsxs(t.Control,{as:"select",...d("gender",{required:"Le genre est requis"}),isInvalid:!!o.gender,required:!0,children:[e.jsx("option",{value:"",children:"Sélectionnez..."}),e.jsx("option",{value:"Male",children:"Homme"}),e.jsx("option",{value:"Female",children:"Femme"})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:(te=o.gender)==null?void 0:te.message})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"email",children:[e.jsx(t.Label,{children:"Email"}),e.jsx(t.Control,{type:"email",...d("email",{required:"L'email est requis",pattern:{value:/^\S+@\S+$/i,message:"Email invalide"}}),isInvalid:!!o.email,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(re=o.email)==null?void 0:re.message})]})]}),e.jsxs(S,{className:"mb-3",children:[e.jsxs(t.Group,{as:c,md:"4",controlId:"phone",children:[e.jsx(t.Label,{children:"Téléphone"}),e.jsx(t.Control,{type:"tel",...d("phone",{required:"Le téléphone est requis"}),isInvalid:!!o.phone,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(ie=o.phone)==null?void 0:ie.message})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"addressLine1",children:[e.jsx(t.Label,{children:"Adresse physique"}),e.jsx(t.Control,{...d("addressLine1")})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"username",children:[e.jsx(t.Label,{children:"Nom d'utilisateur"}),e.jsx(t.Control,{...d("username",{required:"Le nom d'utilisateur est requis"}),isInvalid:!!o.username,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(ne=o.username)==null?void 0:ne.message})]})]}),e.jsxs(S,{className:"mb-3",children:[e.jsxs(t.Group,{as:c,md:"4",controlId:"password",children:[e.jsx(t.Label,{children:"Mot de passe"}),e.jsx(t.Control,{type:"password",...d("password",{required:"Le mot de passe est requis",minLength:{value:6,message:"Le mot de passe doit contenir au moins 6 caractères"}}),isInvalid:!!o.password,required:!0}),e.jsx(t.Control.Feedback,{type:"invalid",children:(oe=o.password)==null?void 0:oe.message})]}),e.jsxs(t.Group,{as:c,md:"4",controlId:"role",children:[e.jsx(t.Label,{children:"Rôle"}),e.jsxs(t.Control,{as:"select",...d("role",{required:"Le rôle est requis"}),required:!0,value:r,onChange:s=>{U(s.target.value),q([])},isInvalid:!!o.role,children:[e.jsx("option",{value:"",children:"Sélectionnez un rôle"}),e.jsx("option",{value:"committee",children:"Comité"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"ong",children:"ONG"}),e.jsx("option",{value:"mission-de-controle-vbg",children:"Mission Contrôle VBG"}),e.jsx("option",{value:"mission-de-controle-pg",children:"Mission Contrôle PG"}),e.jsx("option",{value:"entreprise-vbg",children:"Entreprise VBG"}),e.jsx("option",{value:"entreprise-pg",children:"Entreprise PG"}),e.jsx("option",{value:"ci-vbg",children:"CI VBG"}),e.jsx("option",{value:"ci-pg",children:"CI PG"}),e.jsx("option",{value:"eds-vbg",children:"EDS VBG"}),e.jsx("option",{value:"eds-pg",children:"EDS PG"}),e.jsx("option",{value:"bailleur",children:"Banque mondiale"})]}),e.jsx(t.Control.Feedback,{type:"invalid",children:(ae=o.role)==null?void 0:ae.message})]}),(r==="committee"||r==="manager"||r==="ong"||r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg")&&e.jsxs(t.Group,{as:c,md:"4",controlId:"committee",children:[e.jsx(t.Label,{children:r==="ong"?"ONG":"Comité"}),e.jsxs(t.Control,{as:"select",...d("committee",{required:"Le comité est requis"}),required:!0,isInvalid:!!o.committee,children:[e.jsx("option",{value:"",children:"Sélectionnez un comité"}),pe.filter(s=>r==="ong"?s.type===2:r==="entreprise-vbg"||r==="entreprise-pg"?s.type===3:r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"?s.type===4:s.type===1).map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx(t.Control.Feedback,{type:"invalid",children:(le=o.committee)==null?void 0:le.message})]})]}),(r==="eds-vbg"||r==="eds-pg"||r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg")&&e.jsx(S,{className:"mb-3",children:e.jsxs(t.Group,{as:c,md:"12",controlId:"troncons",children:[e.jsx(t.Label,{children:r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg"?"Sélectionnez un tronçon":"Sélectionnez un ou plusieurs tronçons"}),e.jsx("div",{className:"d-flex flex-wrap gap-2",children:de.map(s=>e.jsx(t.Check,{type:"checkbox",id:`troncon-${s.id}`,label:s.name,checked:w.includes(s.id),onChange:()=>Se(s.id),disabled:(r==="mission-de-controle-vbg"||r==="mission-de-controle-pg"||r==="entreprise-vbg"||r==="entreprise-pg")&&w.length>0&&!w.includes(s.id)},s.id))})]})}),e.jsx(y,{variant:"secondary",onClick:M,className:"me-2 mt-3",children:"Annuler"}),e.jsx(y,{variant:"primary",type:"submit",className:"mt-3",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx($,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"})," Enregistrement..."]}):"Enregistrer"})]})})]}),e.jsxs(h,{show:ce,onHide:B,backdrop:"static",children:[e.jsx(h.Header,{closeButton:!0,children:e.jsx(h.Title,{children:"Mise à jour des accès aux cas d'utilisation"})}),e.jsxs(h.Body,{children:[e.jsxs("p",{children:["Utilisateur ID: ",F]}),e.jsx(t.Check,{type:"checkbox",id:"use-case-0",label:"Aucun",checked:C.includes(0),onChange:()=>K(0)}),Array.from({length:9},(s,i)=>i+1).map(s=>e.jsx(t.Check,{type:"checkbox",id:`use-case-${s}`,label:`Etape ${s}`,checked:C.includes(s),onChange:()=>K(s)},s))]}),e.jsxs(h.Footer,{children:[e.jsx(y,{variant:"secondary",onClick:B,children:"Annuler"}),e.jsx(y,{variant:"primary",onClick:ke,disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx($,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"})," Mise à jour..."]}):"Mettre à jour"})]})]}),e.jsx(Re,{message:be,type:fe,show:ve,onClose:()=>p(!1)})]})}export{Qe as default};
